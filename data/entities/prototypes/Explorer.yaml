tags: [explorer]
physics:
  - - poly
    - { x: 0, y: -31.5 }
    - { x: 16, y: -16 }
    - { x: 16, y: 16 }
    - { x: .1, y: 31.5 }
    - { x: -0.1, y: 31.5 }
    - { x: -16, y: 16 }
    - { x: -16, y: -16 }
navHeight: { x: 1, y: 0 }
behavior:
  canBePlayer: yes
  moveSpeed: 80
  sprintSpeed: 120
  jumpForce: 250
  inventorySlots: 8
  inventorySize: null
model:
  speechBubble:
    origin: speechBubbleOrigin
  skeleton:
    - name: speechBubbleOrigin
      pos: { x: 0, y: -36 }
    - name: gazeTarget
      pos: { x: 100, y: -25 }
    - name: leftFootTarget
      pos: { x: -8, y: 29 }
    - name: rightFootTarget
      pos: { x: 8, y: 29 }
    - name: leftHandTarget
      pos: { x: -11, y: 8 }
    - name: rightHandTarget
      pos: { x: 11, y: 8 }
    - name: body
      render:
        as: sprite
        sprite: explorerBody
        anchor: center
        z: 1
      children:
        - name: neck
          pos: { x: 0, y: -25 }
          ik:
            angleRange: [-100, 100]
          children:
            - name: head
              render:
                as: sprite
                sprite: explorerHead
                anchor: center
                angle: 90
                z: 1
              ik:
                naturalDirection: { x: 0, y: -1 }
              children:
                - name: rightEyeSocket
                  pos: { x: -3, y: -2.4 }
                  children:
                    - name: rightEye
                      pos: { x: -1, y: 0 }
                      render: &eye
                        as: rect
                        anchor: left
                        size: [1, 1]
                        scale: { x: 1, y: 3 }
                        color: white
                        z: 1
                      ik:
                        target: [gazeTarget, 1]
                - name: leftEyeSocket
                  pos: { x: 1, y: -2.4 }
                  children:
                    - name: leftEye
                      pos: { x: -1, y: 0 }
                      render: *eye
                      ik:
                        target: [gazeTarget, 1]
                - name: headlight
                  render:
                    as: light
                    type: spot
                    strength: 1.5
                    near: 50
                    far: 100
                    color: white
                    spread: 15
                    widthMax: 5
            - name: gazeSource
              pos: { x: 0, y: -10 }
              ik:
                target: [gazeTarget, 1]
        - name: leftUpperLeg
          pos: { x: -5, y: 13 }
          render: &leg
            as: polyline
            pts: [{ x: 0, y: 0 }, { x: 0, y: &legLength 9 }]
            angle: 12
            color: white
            join: round
            cap: round
            width: 4
            z: 1
          ik:
            angleRange: &upperLegRange [-90, 30]
          children:
            - name: leftLowerLeg
              render: *leg
              pos: { x: 0, y: *legLength }
              ik:
                angleRange: &lowerLegRange [1, 135]
              children:
                - pos: { x: 0, y: *legLength }
                  children:
                    - name: leftFoot
                      render: &foot
                        as: sprite
                        sprite: explorerFoot
                        anchor: { x: -0.5, y: -1 }
                        z: 1
                      constraint: [angle, body, 0, 0]
                  ik:
                    target: [leftFootTarget, 2]
        - name: rightUpperLeg
          pos: { x: 5, y: 13 }
          render: *leg
          ik:
            angleRange: *upperLegRange
          children:
            - name: rightLowerLeg
              render: *leg
              pos: { x: 0, y: *legLength }
              ik:
                angleRange: *lowerLegRange
              children:
                - pos: { x: 0, y: *legLength }
                  children:
                    - name: rightFoot
                      render: *foot
                      constraint: [angle, body, 0, 0]
                  ik:
                    target: [rightFootTarget, 2]
        - name: leftUpperArm
          pos: { x: -6, y: -12 }
          render:
            as: polyline
            pts: [{ x: &luArmLen -12, y: 0 }, { x: 0, y: 0 }]
            angle: -12
            color: white
            join: round
            cap: round
            width: 3
            z: 1
          ik:
            angleRange: &upperArmRange [-90, 90]
          children:
            - name: leftLowerArm
              pos: { x: *luArmLen, y: 0 }
              render:
                as: polyline
                pts: [{ x: &llArmLen -10, y: 0 }, { x: 0, y: 0 }]
                angle: -12
                color: white
                join: round
                cap: round
                width: 3
                z: 1
              ik:
                angleRange: [-90, 0]
              children:
                - pos: { x: *llArmLen, y: 0 }
                  children:
                    - name: leftHand
                      render: &hand
                        as: sprite
                        sprite: explorerHand
                        anchor: top
                        z: 2
                      constraint: [angle, body, 0, 0]
                  ik:
                    target: [leftHandTarget, 2]
        - name: rightUpperArm
          pos: { x: 6, y: -12 }
          render:
            as: polyline
            pts: [{ x: 0, y: 0 }, { x: &ruArmLen 12, y: 0 }]
            angle: 12
            color: white
            join: round
            cap: round
            width: 3
            z: 1
          ik:
            angleRange: *upperArmRange
          children:
            - name: rightLowerArm
              pos: { x: *ruArmLen, y: 0 }
              render:
                as: polyline
                pts: [{ x: 0, y: 0 }, { x: &rlArmLen 10, y: 0 }]
                angle: 12
                color: white
                join: round
                cap: round
                width: 3
                z: 1
              ik:
                angleRange: [0, 90]
              children:
                - pos: { x: *rlArmLen, y: 0 }
                  children:
                    - name: rightHand
                      render: *hand
                      constraint: [angle, body, 0, 0]
                  ik:
                    target: [rightHandTarget, 2]
    - name: s_bot
      pos: { x: 0, y: 65 }
      sensor: true
    - name: s_side1
      pos: { x: -30, y: 40 }
      sensor: true
    - name: s_side2
      pos: { x: 30, y: 40 }
      sensor: true
  tentacles:
    - name: horn
      bone: head
      pos: { x: 13, y: -1 }
      n: 5
      lps: 3
      render: &tentacle
        color: xt252
        cap: round
        z: 0
      sizes: [2.7, 1, easeOutQuad]
      masses: [1, 1]
      eachConstraints:
        distance: [head, 13, -1]
    - name: tail
      bone: body
      pos: { x: 0, y: 12 }
      n: 8
      lps: 5
      render: *tentacle
      sizes: [4, 1, easeOutQuad]
      masses: [1, 1]
  anims:
    sprintright:
      loop: true
      channels:
        - target: [body, angle]
          keyframes:
            - [0, 10]
          alpha: 30
        - target: [leftHandTarget, pos]
          keyframes:
            - [0, { x: 0, y: -1.5 }]
          alpha: 30
          relative: true
        - target: [rightHandTarget, pos]
          keyframes:
            - [0, { x: 0, y: 1.5 }]
          alpha: 30
          relative: true
    sprintleft:
      loop: true
      channels:
        - target: [body, angle]
          keyframes:
            - [0, -10]
          alpha: 30
        - target: [leftHandTarget, pos]
          keyframes:
            - [0, { x: 0, y: 1.5 }]
          alpha: 30
          relative: true
        - target: [rightHandTarget, pos]
          keyframes:
            - [0, { x: 0, y: -1.5 }]
          alpha: 30
          relative: true
    idle:
      loop: true
      channels:
        - target: [body, pos]
          keyframes:
            - [1, { x: 0, y: -0.5 }, easeInOutSine]
            - [1, { x: 0, y: -1.5 }, easeInOutSine]
        - target: [leftHandTarget, pos]
          keyframes:
            - [1.1, { x: -0.5, y: -1 }, easeInOutSine]
            - [1.1, { x: 0.5, y: -1 }, easeInOutSine]
          relative: true
        - target: [rightHandTarget, pos]
          keyframes:
            - [1.1, { x: 0.5, y: -1 }, easeInOutSine]
            - [1.1, { x: -0.5, y: -1 }, easeInOutSine]
          relative: true
          delay: 0.2
    jump:
      channels:
        - target: [body, pos]
          alpha: 100
          relative: true
          keyframes:
            - [0.1, { x: 0, y: 0 }]
            - [0.1, { x: 0, y: 6 }]
            - [0.1, { x: 0, y: 0 }]
        - target: [leftEye, scale]
          alpha: 100
          keyframes:
            - [0.1, { x: 1, y: 3 }]
            - [0.1, { x: 5, y: 0.5 }]
            - [0.1, { x: 1, y: 3 }]
        - target: [rightEye, scale]
          alpha: 100
          keyframes:
            - [0.1, { x: 1, y: 3 }]
            - [0.1, { x: 5, y: 0.5 }]
            - [0.1, { x: 1, y: 3 }]
  kinematics:
    look:
      origin: head
      target: gazeTarget
    initial: standing
    states:
      walking:
        sprint: [sprintleft, sprintright]
        steps:
          len: 8
          height: 2
          time: 0.06
        allowedComponents: { x: 1, y: 0 }
        bones:
          - bone: leftFoot
            flip: [true, false]
          - bone: rightFoot
            flip: [true, false]
          - bone: leftUpperLeg
            flip: [~, ~, ~, &reflUpperLegRange [-30, 90], *upperLegRange]
          - bone: rightUpperLeg
            flip: [~, ~, ~, *reflUpperLegRange, *upperLegRange]
          - bone: leftLowerLeg
            flip: [~, ~, ~, &reflLowerLegRange [-135, -1], *lowerLegRange]
          - bone: rightLowerLeg
            flip: [~, ~, ~, *reflLowerLegRange, *lowerLegRange]
          - bone: leftFootTarget
            stepMode: step
            phaseOffset: 0
          - bone: rightFootTarget
            stepMode: step
            phaseOffset: 0.5
        transitions: &standing_walking_transition_rule
          - [standing, [logic, 0b0111, [the, grounded], [the, moving]]] # 7 = !grounded || !moving
          # - [climbing, [logic, 0b1000, [the, moving], [hitting, climbable]]] # 8 = moving && onLadder
          - [walking, [the, moving]]
        jumpRule: &standing_walking_jump_rule [[the, grounded], jumping]
      standing:
        anim: idle
        allowedComponents: { x: 1, y: 0 }
        transitions: *standing_walking_transition_rule
        jumpRule: *standing_walking_jump_rule
      jumping:
        anim: jump
        bones:
          - bone: leftFoot
            flip: [~, ~, true]
          - bone: rightFoot
            flip: [~, ~, false]
          - bone: leftUpperLeg
            flip: [~, ~, ~, ~, ~, *reflUpperLegRange]
          - bone: rightUpperLeg
            flip: [~, ~, ~, ~, ~, *upperLegRange]
          - bone: leftLowerLeg
            flip: [~, ~, ~, ~, ~, *reflLowerLegRange]
          - bone: rightLowerLeg
            flip: [~, ~, ~, ~, ~, *lowerLegRange]
        allowedComponents: { x: 1, y: 0 }
        transitions:
          - [standing, [the, grounded]]
        jumpRule: [no]
      # climbing:
      #   gravityScale: 0
      #   bones: # TODO
      #   transitions:
      #     - [standing, [not, [hitting, climbable]]]
      #   jumpRule: [true, standing]
      # swimming:
      #   # TODO
hooks:
  loadAsDisplay:
    - do
    - [boneSet, [list, headlight, light, excludeTags], [list, "*"]]
  action1: [as, [my, agent], bePlayer]
  action2:
    [
      as,
      [my, agent],
      do,
      [say, "BEEP BOOP. My name is NIC, and I am your helpful assistant."],
      [anim, ouch],
      [say, "...wait, did I just reboot? Am I going crazy?"],
    ]
  step:
    [
      playsound,
      [
        if,
        &metalCond [
          logic,
          0b00011110,
          [hitting, metal, s_side1],
          [hitting, metal, s_side2],
          [hitting, metal, s_bot],
        ],
        footsteps_metal,
        footsteps,
      ],
    ]
  jump: [playsound, jump]
  landed:
    [
      playsound,
      [if, *metalCond, thud_metal, thud],
      false,
      [mapc, [the, force], 0, 800, 0, 1],
    ]
